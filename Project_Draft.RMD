---
title: "Stat Final Project Draft, Group 316:1 - Injury Severity Comparison Between ADS Cars and Level 2 Cars Based on Weather Conditions"
output: html_document
date: "2024-07-26"
bibliography: references.bib
---

## Group Member Names: 

Nicole Andrews\
Lucky Hu\
Ahmad Hinnawi\
Brooke Hrdlicka

```{r}
library(tidyverse)
library(readr)
library(dplyr)
library(ggplot2)
```

## Introduction:

Car accidents are among the major causes of global problems, causing death, injury, and economic loss in great numbers each year. These tragedies do not only affect the concerned victims and their families, but also pose a heavy load on the health system and the economy of countries. In this regard, understanding factors that contribute to such accidents is essential to the development of effective preventive strategies and improvement of measures toward road safety, with a view to reducing associated costs.

Through our analysis, we will try to deduce the relationship between weather condition, and car injuries. Precisely, we want to answer the following questions: **Are ASD equipped cars less likely to cause severe injuries than Level 2 equipped cars?**

In this study, by analyzing data from the National Highway Traffic Safety Administration [@NHTSA2023], we found that ADS cars are less likely to cause severe injuries than level 2 cars. This information can be used in making policy decisions to upgrade road safety measures and bring down both the frequency and severity of car accidents considerably.

## Background

This dataset includes crash reporting, which is mandated by the National Highway Traffic Safety Administration. This general order on the crash reporting standing requires vehicle and equipment manufacturers to report crashes involving ADAS and ADS. Data is provided from manufacturers obligated to report any qualifying crashes within 24 hours of learning about them. Manufacturers gather information from a variety of sources, including complaints/claims, telematics, field reports, testing, law enforcement, media, or others. Subsequently, manufacturers upload these data through the appropriate channels to the NHTSA. Each crash report contains the detailed description of the accident, usually including the date and time of the crash, location,  circumstances of the crash-e.g. weather, outcomesâ€”e.g., injuries or fatalities.

### ADS vs Level 2

Automated driving systems, still in development, encompass SAE Levels 3 through 5. In its mature state, a vehicle equipped with ADS aims to perform the entire dynamic driving task on a sustained basis within a defined operational design domain without driver involvement. While these vehicles are in development and are being tested on public roads in limited capacities, they are not available for consumer purchase at this time.

Level 2 advanced driver assistance systems provide both speed and steering input when the driver assistance system is engaged but require the human driver to remain fully engaged in the driving task at all times.

In short, ADS vehicles are more advanced than Level 2 vehicles, as they are designed to perform the entire driving task without human intervention. However, people are worried about the safety of these vehicles. Our study aims to investigate **whether ADS vehicles are safer than Level 2 vehicles in terms of causing severe injuries in car accidents.**


##  Data: 


The primary variables in the crash dataset include:

- Crash time and date: When the crash happened.
- Location: Geographical location of the crash.
- Information about the vehicle: make, model, and ADAS/ADS capabilities.
- Injuries/fatalities: Number and seriousness of injuries or fatalities resulting from the crash.
- Reporting Entity: Source that reported the crash.
- Environmental conditions: Weather and road condition at the time of the crash. 

This data was provided by the National Highway Traffic Safety Administration. Dataset used and more information can be found via the NHTSA's website on crash reporting [@NHTSA2023].

The datasets contained incident report data from January 1, 2023 through June 17, 2024. Each row in the dataset represents a single crash incident. The size of the dataset is 3918 rows and 137 columns. The name of our dataset is 'combined_data.csv'. 

## Graph: 

We include graphs for the weather conditions to be consistent with our proposal. But the primary question we focus on after the feedback from the professor is to compare the injury severity between ADS and Level 2 vehicles.

### Description:

In this section, we create two bar graphs for each dataset. We break our dataset into combined, only ADS vehicles, and only level2 ADS vehicles. The first graph shows the number of accidents by weather conditions. The weather conditions are categorized into two groups: Clear and Other. The second graph shows the number of accidents by injury severity. The severity of injuries is categorized into five levels: No Injuries Reported, Minor, Moderate, Serious, and Fatality.

```{r}

getwd()
setwd("/Users/lucky/Documents/240/stat240-Group-Project")
# Load the data
crash_data <- read.csv("/Users/lucky/Documents/240/stat240-Group-Project/crash_data.csv")
colunm_name <- colnames(crash_data)
# Weather - Clear	Weather - Snow	Weather - Cloudy	Weather - Fog/Smoke	Weather - Rain	Weather - Severe Wind	Weather - Unknown	Weather - Other	Weather - Other Text Highest, Injury Severity Alleged
level_data <- read.csv("/Users/lucky/Documents/240/stat240-Group-Project/level2.csv")

# Drop all the columns of the data set other than 1, 12, 65, 72-81, 83

crash_data <- crash_data[, c(1, 12,  72:81, 83)]
# Save it to a new csv file
write.csv(crash_data, file = "crash_data2.csv")
level2_data <- level_data[, c(1, 12,  72:81, 83)]
write.csv(level2_data, file = "level2_data2.csv")


# Create a new column for the dataset called level with crash_data has value 5 and the level2_data has value 2
crash_data$level <- 5
level2_data$level <- 2

```

```{r}

get_weather_count <- function(data){
data_melt <- data %>%
    pivot_longer(cols = starts_with("Weather"), names_to = "Weather_Condition", values_to = "Presence")
  
  weather_data <- data_melt %>% filter(Presence == "Y")
  
  weather_data$Weather_Condition <- ifelse(weather_data$Weather_Condition == "Weather...Clear", "Clear", "Other")
  
  weather_counts <- weather_data %>%
    group_by(Weather_Condition) %>%
    summarise(Count = n())
  return(weather_counts)
}

plot_weather <- function(weather_counts, name) {
  
  ggplot(weather_counts, aes(x = Weather_Condition, y = Count)) +
    geom_bar(stat = "identity", fill = "blue", width = 0.5, alpha = 0.5) +
    labs(x = "Weather Conditions", y = "Number of Accidents", title = name) +
    theme_minimal(base_size = 15) +
    theme(
      axis.text.x = element_text(angle = 65, hjust = 1),
      plot.title = element_text(size = 14, face = "bold"),
      legend.title = element_text(size = 10),
      legend.text = element_text(size = 8)
    )
}

get_injury_count <- function(data){
	 injury_counts <- data %>%
    filter(Highest.Injury.Severity.Alleged != "Unknown") %>%
    group_by(Highest.Injury.Severity.Alleged) %>%
    summarise(Count = n())
  return(injury_counts)
}

plot_injury_severity <- function(injury_counts, name) { 
  # Define the order and colors for injury severity
  injury_order <- c("No Injuries Reported", "Minor", "Moderate", "Serious", "Fatality")
  injury_colors <- c("No Injuries Reported" = "green", "Minor" = "yellow", "Moderate" = "orange", "Serious" = "red", "Fatality" = "black")
  
  ggplot(injury_counts, aes(x = factor(Highest.Injury.Severity.Alleged, levels = injury_order), y = Count, fill = Highest.Injury.Severity.Alleged)) +
    geom_bar(stat = "identity", width = 0.5, alpha = 0.7) +
    scale_fill_manual(values = injury_colors) +
    labs(x = "Injury Severity", y = "Number of Accidents", title = name) +
    theme_minimal(base_size = 15) +
    theme(
      axis.text.x = element_text(angle = 65, hjust = 1),
      plot.title = element_text(size = 14, face = "bold"),
      legend.title = element_text(size = 10),
      legend.text = element_text(size = 8)
    )
}

get_group_injury_count <- function(data){
injury_counts <- data %>%
    filter(Highest.Injury.Severity.Alleged != "Unknown") %>%
    mutate(Injury_Group = ifelse(Highest.Injury.Severity.Alleged %in% c("No Injuries Reported", "Minor"), 
                                 "No Injuries/Minor", "Moderate/Serious/Fatality")) %>%
    group_by(Injury_Group) %>%
    summarise(Count = n())
	return(injury_counts)
}
plot_grouped_injury_severity <- function(injury_counts, name) {

  ggplot(injury_counts, aes(x = Injury_Group, y = Count, fill = Injury_Group)) +
    geom_bar(stat = "identity", width = 0.5, alpha = 0.7) +
    scale_fill_manual(values = c("No Injuries/Minor" = "green", "Moderate/Serious/Fatality" = "red")) +
    labs(x = "Injury Severity Group", y = "Number of Accidents", title = name) +
    theme_minimal(base_size = 15) +
    theme(
      axis.text.x = element_text(angle = 45, hjust = 1),
      plot.title = element_text(size = 14, face = "bold"),
      legend.title = element_text(size = 10),
      legend.text = element_text(size = 8)
    )
  
}
combined_data <- rbind(crash_data, level2_data)
combined_weather <- get_weather_count(combined_data)
plot_weather(combined_weather, "Number of Accidents by Weather Conditions for Combined Data")
combined_injury <- get_injury_count(combined_data)
plot_injury_severity(combined_injury,  "Number of Accidents by Injury Severity for Combined Data")
 
# Example usage with the data
ADS_weather <- get_weather_count(crash_data)

plot_weather(ADS_weather, "Number of Accidents by Weather Conditions for ADS Vehicles")

ADS_injury <- get_injury_count(crash_data)

plot_injury_severity(ADS_injury, "Number of Accidents by Injury Severity for ADS Vehicles")

level2_weather <- get_weather_count(level2_data)
plot_weather(level2_weather, "Number of Accidents by Weather Conditions for Level 2 Vehicles")

level2_injury <- get_injury_count(level2_data)
plot_injury_severity(level2_injury, "Number of Accidents by Injury Severity for Level 2 Vehicles")
```


```{r}
print(ADS_weather)
print(ADS_injury)
print(level2_weather)
print(level2_injury)
```

## Graph for Our analysis:

We summarized the No Injuries and Minor, into one group and the Moderate, Serious, and Fatality into another group.  This was aimed to determine if there are significant differences between mild injuries compared to more severe injuries.

```{r}
ADS_group_injur <- get_group_injury_count(crash_data)
plot_grouped_injury_severity(ADS_group_injur, "Number of Accidents by Injury Severity for ADS Vehicles")

level2_group_injur <- get_group_injury_count(level2_data)
plot_grouped_injury_severity(level2_group_injur, "Number of Accidents by Injury Severity for level2 Vehicles")
```

## Analysis:

Here is the summary of the number of accidents by injury severity for ADS and Level2 vehicles. The severity of injuries is categorized into two groups: No Injuries/Minor and Moderate/Serious/Fatality. The bar graph shows the number of accidents that occurred in each injury severity group.

```{r}
print(ADS_group_injur)
print(level2_group_injur)
```


###  Question:

> Do car crash causes severe injuries(Moderate/Serious/Fatality) more often with ADS equipped than ADS Level2 equipped? 

### Statistical Model:

- $p_1$ is the probability that a car crash causes severe injuries(Moderate/Serious/Fatality) with ADS equipped.
- $p_2$ is the probability that a car crash causes severe injuries(Moderate/Serious/Fatality) with ADS Level2 equipped.


Let $\hat{p}_1$ and $\hat{p}_2$ be the emperical probabilities of a car crash causes severe injuries(Moderate/Serious/Fatality) with ADS equipped and ADS Level2 equipped, respectively.

$$X_1 | ~ p_1 \sim \text{Binomial}(1131, p_1)$$
$$X_2 | ~ p_2 \sim \text{Binomial}(533, p_2)$$

Where $X_1$ and $X_2$ are the number of car crash causes severe injuries(Moderate/Serious/Fatality) with ADS equipped and ADS Level2 equipped, respectively.

### Hypothesis:

 $$H_0: p_1 = p_2$$
  $$H_a: p_1 \neq p_2$$

- The null hypothesis is that the probability that a car crash causes severe injuries(Moderate/Serious/Fatality) with ADS equipped is equal to the probability that a car crash causes severe injuries(Moderate/Serious/Fatality) with ADS Level2 equipped.
- The alternative hypothesis is that the probability that a car crash causes severe injuries(Moderate/Serious/Fatality) with ADS equipped is not equal to the probability that a car crash causes severe injuries(Moderate/Serious/Fatality) with ADS Level2 equipped.

### Test statistic: We choose to use the difference of the point estimates as the test statistic.

```{r}
test_stat = 52/1131 - 177/533
test_stat
```

> In the experiment data, we observe the ADS equipped car crash causes severe injuries(Moderate/Serious/Fatality) 28.6% less often than the ADS Level2 equipped car crash.

### Null Sampling Distribution:

- If the null hypothesis is true, then $p_1 = p_2$ the distribution of the test statistic is whatever it is when $X_1$ and $X_2$ are drawn from binomial distribution with the same success probability p. 
- To estimate $p$ from the data, we combine both samples.

$$\bar{p} = \frac{X_1 + X_2}{1131 + 533} = \frac{52+177}{1131+533} = 0.1376$$

### Calculate the p-value:

```{r}
p0 = (52+177)/(1131+533)
test_stat = 52/1131 - 177/533
n1 = 1131
n2 = 533
B = 2000000

set.seed(20240726)

sim = tibble(
  x1 = rbinom(B, n1, p0),
  n1 = n1, 
  x2 = rbinom(B, n2, p0),
  n2 = n2, 
  phat1 = x1/n1,
  phat2 = x2/n2,
  diff = phat1 - phat2)

sim %>% print(n=15, width = Inf)
```

```{r}
pvalue_sim = sim %>% 
  summarize(
    pvalue = mean( abs(diff) > abs(test_stat) | near(abs(diff), abs(test_stat))) ) %>% 
  pull(pvalue)
print(test_stat)
summary(sim$diff)
pvalue_sim
print(paste("The p-value is", pvalue_sim))
```

> The p-value is 0. Since the p-value is less than 0.05, we reject the null hypothesis. There is enough evidence to suggest that the probability that a car crash causes severe injuries(Moderate/Serious/Fatality) with ADS equipped is not equal to the probability that a car crash causes severe injuries(Moderate/Serious/Fatality) with ADS Level2 equipped.

## Interpretation:

We conclude there is enough evidence to suggest that the probability that a car crash causes severe injuries(Moderate/Serious/Fatality) with ADS equipped is less than the probability that a car crash causes severe injuries(Moderate/Serious/Fatality) with ADS Level2 equipped.


### Simulation Check:

```{r}
sim %>% 
  summarize(mean = mean(diff),
            sd = sd(diff),
            pvalue = mean(abs(diff) >= abs(test_stat)))
```

```{r}
ggplot(sim, aes(x=diff)) +
  geom_density(fill = "papayawhip") +
  geom_vline(xintercept = test_stat, color = "red", linetype = "dashed") +
  geom_hline(yintercept = 0) +
  xlab("Difference in Sample Proportions") +
  theme_minimal()
```

- We see that the sampling distribution is well-approximated by a normal curve.
- The test statistic is far out in the tail, so we expect a small p-value.

### Normal Approximation:
```{r}
se = sqrt( p0*(1-p0)/n1 + p0*(1-p0)/n2 )
z = test_stat / se
z
```

```{r}
## p-value is twice the area to the right of z under the standard normal curve.
## this is also twice the area to the left of -|z| due to symmetry
pvalue_z = 2*pnorm(-abs(z))
pvalue_z
```
The simulation and the theory can be interpreted in the same way. 

#  Discussion/ Conclusion:

There is very strong evidence that the probability that a car crash causes severe injuries(Moderate/Serious/Fatality) with ADS equipped is significantly less than the probability that a car crash causes severe injuries with ADS Level2 equipped. (p = 2.776592e-56, z-test for difference in proportions)

# References: 
